# =============================================================================
# nginx-rtmp.conf — Configuration nginx + module RTMP pour Orbis Alternis
# =============================================================================
# Ce fichier est GÉNÉRÉ dynamiquement par scripts/diffuser.sh
# à partir des valeurs de conf/orbis.conf (clés de flux, ports...).
#
# NE PAS éditer manuellement ce fichier ; modifier conf/orbis.conf.
#
# Installation :
#   sudo apt install nginx libnginx-mod-rtmp
#   sudo ln -sf /home/thalyn/OrbisAlternis/conf/nginx-rtmp.conf \
#               /etc/nginx/sites-enabled/orbis-rtmp
#   (ou copier dans /etc/nginx/nginx.conf selon votre config)
# =============================================================================

# Charge le module RTMP (Raspberry Pi OS Bookworm)
load_module modules/ngx_rtmp_module.so;

worker_processes auto;
worker_rlimit_nofile 8192;

events {
    worker_connections 512;
}

# --- Bloc RTMP ---------------------------------------------------------------
rtmp {
    server {
        listen NGINX_PORT_RTMP;    # Remplacé par scripts/diffuser.sh
        chunk_size 4096;
        max_message 1M;

        application NGINX_CHEMIN_APPLICATION {
            live on;
            record off;
            allow publish 127.0.0.1;
            deny publish all;
            allow play all;

            # Pousser vers DLive (RTMP direct)
            push DLIVE_SERVEUR/DLIVE_CLE_FLUX;

            # Pousser vers Kick via Stunnel local (RTMPS chiffré)
            push rtmp://127.0.0.1:STUNNEL_PORT_LOCAL/app/KICK_CLE_FLUX;
        }
    }
}

# --- Bloc HTTP (statistiques RTMP) ------------------------------------------
http {
    server {
        listen 8088;
        server_name localhost;

        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root /usr/share/doc/libnginx-mod-rtmp/;
        }

        location /controle {
            rtmp_control all;
        }
    }
}
